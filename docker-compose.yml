services:
  traefik:
    image: traefik:v3.0
    command:
      - "--log.level=DEBUG"
      - "--accesslog=true"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    networks:
      - proxy-net
    restart: unless-stopped

  keycloak:
    image: quay.io/keycloak/keycloak:24.0
    command: start-dev --import-realm
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-db:5432/${POSTGRES_DB}
      KC_DB_USERNAME: ${POSTGRES_USER}
      KC_DB_PASSWORD: ${POSTGRES_PASSWORD}
      KC_HOSTNAME: ${DOMAIN_AUTH}
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
      KC_PROXY: edge
    volumes:
      - ./keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
    networks:
      - proxy-net
      - backend-net
    depends_on:
      - keycloak-db
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=cloud-collaborative-workspace_proxy-net"
      - "traefik.http.routers.keycloak.rule=Host(`${DOMAIN_AUTH}`)"
      - "traefik.http.routers.keycloak.entrypoints=websecure"
      - "traefik.http.routers.keycloak.tls=true"
      - "traefik.http.services.keycloak.loadbalancer.server.port=8080"

  keycloak-db:
    image: postgres:16
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - keycloak_db_data:/var/lib/postgresql/data
    networks:
      - backend-net
    restart: unless-stopped

  nextcloud:
    image: nextcloud:29-apache
    environment:
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_HOST: nextcloud-db
      NEXTCLOUD_ADMIN_USER: ${NEXTCLOUD_ADMIN_USER}
      NEXTCLOUD_ADMIN_PASSWORD: ${NEXTCLOUD_ADMIN_PASSWORD}
      REDIS_HOST: nextcloud-redis
      OVERWRITEHOST: ${DOMAIN_NC}
      OVERWRITEPROTOCOL: https
      TRUSTED_PROXIES: 172.16.0.0/12 # Adjust based on network subnet if needed, or use specific IP
    volumes:
      - nextcloud_data:/var/www/html
      - ./nextcloud/custom.ini:/usr/local/etc/php/conf.d/custom.ini
    networks:
      - proxy-net
      - backend-net
    depends_on:
      - nextcloud-db
      - nextcloud-redis
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=cloud-collaborative-workspace_proxy-net"
      - "traefik.http.routers.nextcloud.rule=Host(`${DOMAIN_NC}`)"
      - "traefik.http.routers.nextcloud.entrypoints=websecure"
      - "traefik.http.routers.nextcloud.tls=true"
      - "traefik.http.services.nextcloud.loadbalancer.server.port=80"

  nextcloud-db:
    image: mariadb:10.11
    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
    volumes:
      - nextcloud_db_data:/var/lib/mysql
    networks:
      - backend-net
    restart: unless-stopped

  nextcloud-redis:
    image: redis:7
    networks:
      - backend-net
    restart: unless-stopped

  onlyoffice:
    image: onlyoffice/documentserver:latest
    environment:
      JWT_ENABLED: "true"
      JWT_SECRET: ${ONLYOFFICE_JWT_SECRET}
    volumes:
      - onlyoffice_data:/var/www/onlyoffice/Data
    networks:
      - proxy-net
      - backend-net
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=cloud-collaborative-workspace_proxy-net"
      - "traefik.http.routers.onlyoffice.rule=Host(`${DOMAIN_OFFICE}`)"
      - "traefik.http.routers.onlyoffice.entrypoints=websecure"
      - "traefik.http.routers.onlyoffice.tls=true"
      - "traefik.http.services.onlyoffice.loadbalancer.server.port=80"
    restart: unless-stopped

networks:
  proxy-net:
    driver: bridge
  backend-net:
    driver: bridge
    internal: true

volumes:
  keycloak_db_data:
  nextcloud_data:
  nextcloud_db_data:
  onlyoffice_data:
